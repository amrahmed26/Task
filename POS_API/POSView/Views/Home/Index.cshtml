@model POSView.Models.ItemsModel
@{
    ViewData["Title"] = "Home Page";

    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">

    <div class="col-md-4">
        <p>Categories</p>
        <br />
       <div id="categories">
           
       </div>
        <hr />  <p>Products</p><br />
       <div id="products">
          
       </div>

   @*         <label asp-for="CategoryId"   class="control-label">Category</label>
            <select  class="form-control" asp-for="CategoryId">
                <option></option>

            </select>*@
            @*     <label asp-for="ProductId"   class="control-label">Product</label>
            <select  class="form-control" asp-for="ProductId" >
                <option></option>

            </select>*@
@*        <label  class="control-label">Quantity</label>

        <input class="form-control" type="number" id="QTY" />*@
             <div class="form-group">
               @* <input type="submit" value="Create" class="btn btn-primary" />*@
      @*      <button class="btn btn-primary" onclick=" PostProductToInvoice()">Add To Invoice</button>*@
            </div>
            </div>
    <div class="col-md-8">
       @* <button class="btn btn-primary" onclick=" ShowInvoice()">Show Invoice</button>*@
        <div id="invoice">
        </div>
        <p id="price"></p>
        <center><button class="btn btn-success" onclick="SaveItems()">Save</button></center><br />
        <center><a href="http://localhost:5259/api/Products/ExportToExcel" class="btn btn-success">Export Products To Excel</a></center>



    </div>
           
    
    </div>
   

@section scripts{
    <script>
        $(document).ready(function(){
            ShowInvoice();
            var category = $('#Categories');
            

            $.ajax({
                url:'http://localhost:5259/api/categories',
                type: 'GET',
                success:function(results){
                    var btn='';
                    $.each(results,function(i,result){
                        console.log(result.name);
                      //  category.append($('<option></option>').attr('value', result.id).text(result.name));
                    
                        btn += '<button class="btn btn-primary"onclick=" GetProductsByCategory(' + result.id + ')" >' + result.name + '</button><span>  </span>';



                    }); $('#categories').html(btn);
                },
                 error:function(){
                        alert("Error");
                    }


            });
            $.ajax({
                url: 'http://localhost:5259/api/Products',
                typeof:'Get',
                success:function(results){
                    var btn='';
                    $.each(results,function(i,result){

                        btn += '<button class="btn btn-danger"onclick=" PostProductToInvoice(' + result.id + ')" >' + result.name + '</button><span>  </span>';


                    });
                    $('#products').html(btn);

                },
                error:function(error){
                    alert("error");
                }
            });
       
            $('#CategoryId').on('click',function(){
                var categoryId=$(this).val();
                var pro=$('#ProductId');
                pro.empty();
                if(categoryId!=''){

                
                $.ajax({
                        url: 'http://localhost:5259/api/Products/GetProductsByCategory/' + categoryId,
                    method:'Get',
                    success:function(results){
                        var btn='';
                        console.log(results);
                        $.each(results,function(i,result){
                                console.log(result.name);
                            //pro.append($('<option></option>').attr('value', result.id).text(result.name));
                                btn += '<button class="btn btn-primary"onclick=" PostProductToInvoice(' + result.id+ ')" >' + result.name + '</button><span>  </span>';
                             
                           

                        }); $('#products').html(btn);
                    },
                    error:function(){
                        alert("Error");
                    }
                });
                }

            });
            

        });
        function GetProductsByCategory(categoryId) {
            $.ajax({
                url: 'http://localhost:5259/api/Products/GetProductsByCategory/' + categoryId,
                method: 'Get',
                success: function (results) {
                    var btn = '';
                    console.log(results);
                    $.each(results, function (i, result) {
                        console.log(result.name);
                        //pro.append($('<option></option>').attr('value', result.id).text(result.name));
                        btn += '<button class="btn btn-danger"onclick=" PostProductToInvoice(' + result.id + ')" >' + result.name + '</button><span>  </span>';



                    }); $('#products').html(btn);
                },
                error: function () {
                    alert("Error");
                }
            });
        }
        function PostProductToInvoice(Id){
            var invoiceId=1;
            var productId = Id;
            var qTY = $('#QTY').val();
            var totalPrice=0;
            var obj=new Object();
            obj.invoiceId= invoiceId;
            obj.productId = productId;
            obj.totalPrice = totalPrice;
            obj.qty = 1;
            $.ajax({
                url: 'Home/PostToInvoice',
               type: 'post',
               data:obj,
             
               success:function(result){
                    Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: 'Added Successfully',
                    showConfirmButton: false,
                    timer: 2000
                })
                    ShowInvoice();

               },
               error:function(error){
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Can not Add item twice',
                        showConfirmButton: false,
                        timer: 2000
                    })
                   
               }





            });
        }

        function ShowInvoice(){
            $.ajax({
                url: 'Home/GetInvoice',
                type:'GET',
                success:function(results){
                    var table='';
                    var price=0;
                 
                    table += '<table class="table table-striped table-bordered">';
                    table += '<tr> <th>invoiceId</th> <th>productName</th> <th>qty</th> <th>Price</th>  </tr>';
                   $.each(results,function(result,i){

                        table += '<tr>';
                        table += '<td>' + i.invoicetId + '</td>';
                        table += '<td>' + i.productName + '</td>';
                        table += '<td>' + i.qty + '</td>';
                        table+= '<td>' + i.totalPrice + '</td>';
                        table += '<td> </td>';
                        price=i.totalPrice+price;

                   });  
                   table+='</tr>'; 
                   table+='</table>';
                   console.log(price);
                    $('#invoice').html(table);
                    document.getElementById("price").innerHTML = "Total Price Of Invoice = " + price;
                },
           
                error:function(error){
                    alert("error");

                }

            });
        }
        function SaveItems() {
            $.ajax({
                url: 'http://localhost:5259/api/Invoices/ConfirmInvoice/1',
                        type: 'POST',
                success: function (result) {
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Added Successfully',
                        showConfirmButton: false,
                        timer: 2000
                    })
                },
                error: function (error) {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Some thing wrong',
                        showConfirmButton: false,
                        timer: 2000
                    })
                }
            });
        }


    </script>
}
